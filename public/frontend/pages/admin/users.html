<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H·ªôi Vi√™n - Gym Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        
        body { display: flex; height: 100vh; overflow: hidden; background: #f8f9fa; }
        .sidebar { width: 250px; background: #343a40; color: white; flex-shrink: 0; }
        .sidebar a { color: #cfd2d6; text-decoration: none; display: block; padding: 15px; border-bottom: 1px solid #4b545c; }
        .sidebar a:hover, .sidebar a.active { background: #007bff; color: white; }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .table-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="text-center py-3 border-bottom">GYM MASTER</h3>
        <a href="dashboard.html">üìä T·ªïng Quan</a>
        <a href="users.html" class="active">üë• Qu·∫£n L√Ω H·ªôi Vi√™n</a> 
        <a href="packages.html">üì¶ Qu·∫£n L√Ω G√≥i T·∫≠p</a>
        <a href="#" onclick="logout()">üö™ ƒêƒÉng Xu·∫•t</a>
    </div>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Danh S√°ch H·ªôi Vi√™n</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus"></i> Th√™m H·ªôi Vi√™n
            </button>
        </div>

        <div class="table-box">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>H·ªç T√™n</th>
                        <th>Email</th>
                        <th>Vai Tr√≤</th>
                        <th>SƒêT</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="6" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m H·ªôi Vi√™n M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label>H·ªç t√™n:</label>
                            <input type="text" id="newName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Email:</label>
                            <input type="email" id="newEmail" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>M·∫≠t kh·∫©u:</label>
                            <input type="text" id="newPassword" class="form-control" value="123456" required>
                        </div>
                        <div class="mb-3">
                            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="text" id="newPhone" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Vai tr√≤:</label>
                            <select id="newRole" class="form-select">
                                <option value="member">H·ªôi vi√™n (Member)</option>
                                <option value="pt">Hu·∫•n luy·ªán vi√™n (PT)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewUser()">L∆∞u L·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a 
        const token = localStorage.getItem('gym_token');
        if (!token) window.location.href = '../../login.html'; // Kh√¥ng c√≥ th√¨ ƒëu·ªïi v·ªÅ trang Login

        // --- H√ÄM 1: L·∫§Y DANH S√ÅCH USER T·ª™ SERVER ---
        async function fetchUsers() {
            try {
                // G·ªçi ƒëi·ªán l√™n Server xin d·ªØ li·ªáu (API GET /users)
                const response = await fetch('http://localhost/QLPG/public/api/users', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token } // Ph·∫£i ƒë∆∞a Token ra m·ªõi ƒë∆∞·ª£c v√†o
                });
                
                // ƒê·ªçc d·ªØ li·ªáu tr·∫£ v·ªÅ
                const data = await response.json();
                
                // Mang d·ªØ li·ªáu ƒë√≥ ƒëi v·∫Ω b·∫£ng
                renderTable(data.data);
            } catch (error) { 
                console.error(error); // In l·ªói ra console n·∫øu m·∫°ng h·ªèng
            }
        }

        // --- H√ÄM 2: V·∫º D·ªÆ LI·ªÜU L√äN B·∫¢NG HTML ---
        function renderTable(users) {
            // T√¨m c√°i khung b·∫£ng (tbody)
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = ''; // X√≥a s·∫°ch b·∫£ng c≈©
            
            // N·∫øu kh√¥ng c√≥ ai th√¨ hi·ªán th√¥ng b√°o
            if (!users || users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }

            // L·∫∑p qua t·ª´ng ng∆∞·ªùi (user) v√† t·∫°o m·ªôt d√≤ng (tr)
            users.forEach(user => {
                // Ki·ªÉm tra role ƒë·ªÉ t√¥ m√†u cho ƒë·∫πp (PT m√†u v√†ng, Member m√†u xanh)
                const roleColor = user.role === 'pt' ? 'bg-warning' : 'bg-info';
                
                // T·∫°o HTML cho d√≤ng ƒë√≥
                tbody.innerHTML += `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge ${roleColor}">${user.role}</span></td>
                        <td>${user.phone || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        // --- H√ÄM 3: TH√äM USER M·ªöI (Khi b·∫•m n√∫t L∆∞u ·ªü Modal) ---
        async function saveNewUser() {
            // Gom d·ªØ li·ªáu t·ª´ c√°c √¥ input v√†o m·ªôt bi·∫øn
            const data = {
                name: document.getElementById('newName').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value,
                phone: document.getElementById('newPhone').value,
                role: document.getElementById('newRole').value
            };
            
            try {
                // G·ª≠i d·ªØ li·ªáu l√™n Server (API POST /users)
                const response = await fetch('http://localhost/QLPG/public/api/users', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json' // B√°o l√† t√¥i g·ª≠i JSON nh√©
                    },
                    body: JSON.stringify(data) // ƒê√≥ng g√≥i d·ªØ li·ªáu th√†nh JSON
                });
                
                const result = await response.json();
                
                // N·∫øu Server b·∫£o OK (status = true)
                if (result.status) {
                    alert("‚úÖ Th√†nh c√¥ng!");
                    // T·∫Øt Modal ƒëi
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    // X√≥a tr·∫Øng form
                    document.getElementById('addUserForm').reset();
                    // T·∫£i l·∫°i danh s√°ch ngay l·∫≠p t·ª©c ƒë·ªÉ th·∫•y ng∆∞·ªùi m·ªõi
                    fetchUsers();
                } else { 
                    alert("L·ªói: " + result.message); // Hi·ªán l·ªói n·∫øu c√≥
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // --- H√ÄM 4: X√ìA USER (Khi b·∫•m n√∫t Th√πng r√°c) ---
        async function deleteUser(id) {
            // H·ªèi l·∫°i cho ch·∫Øc ch·∫Øn
            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªôi vi√™n n√†y?")) return;
            
            try {
                // G·ªçi Server b·∫£o x√≥a (API DELETE /users/{id})
                await fetch(`http://localhost/QLPG/public/api/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                // X√≥a xong th√¨ t·∫£i l·∫°i danh s√°ch
                fetchUsers();
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }
        

        // --- H√ÄM 5: ƒêƒÇNG XU·∫§T ---
        function logout() { 
            localStorage.removeItem('gym_token'); // X√≥a ch√¨a kh√≥a
            window.location.href = '../../login.html'; // V·ªÅ trang ƒëƒÉng nh·∫≠p
        }
        
        // --- CH·∫†Y NGAY KHI V√ÄO TRANG ---
        fetchUsers();
    </script>
</body>
</html>