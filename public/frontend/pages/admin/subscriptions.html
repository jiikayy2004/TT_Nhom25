<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒêƒÉng K√Ω - Gym Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { display: flex; height: 100vh; overflow: hidden; background: #f8f9fa; }
        .sidebar { width: 250px; background: #343a40; color: white; flex-shrink: 0; }
        .sidebar a { color: #cfd2d6; text-decoration: none; display: block; padding: 15px; border-bottom: 1px solid #4b545c; }
        .sidebar a:hover, .sidebar a.active { background: #007bff; color: white; }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .table-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="text-center py-3 border-bottom">GYM MASTER</h3>
        <a href="dashboard.html">üìä T·ªïng Quan</a>
        <a href="users.html">üë• Qu·∫£n L√Ω H·ªôi Vi√™n</a>
        <a href="packages.html">üì¶ Qu·∫£n L√Ω G√≥i T·∫≠p</a>
        <a href="subscriptions.html" class="active">üìù ƒêƒÉng K√Ω G√≥i</a>
        <a href="bookings.html">üìÖ L·ªãch T·∫≠p PT</a>
        <a href="#" onclick="logout()">üö™ ƒêƒÉng Xu·∫•t</a>
    </div>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Danh S√°ch ƒêƒÉng K√Ω</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSubModal">
                <i class="fas fa-plus"></i> ƒêƒÉng K√Ω M·ªõi
            </button>
        </div>

        <div class="table-box">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>H·ªôi Vi√™n</th>
                        <th>G√≥i T·∫≠p</th>
                        <th>Ng√†y B·∫Øt ƒê·∫ßu</th>
                        <th>Ng√†y H·∫øt H·∫°n</th>
                        <th>Tr·∫°ng Th√°i</th>
                    </tr>
                </thead>
                <tbody id="subTableBody">
                    <tr><td colspan="6" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="addSubModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ƒêƒÉng K√Ω G√≥i T·∫≠p Cho H·ªôi Vi√™n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addSubForm">
                        <div class="mb-3">
                            <label>Ch·ªçn H·ªôi Vi√™n:</label>
                            <select id="selectUser" class="form-select" required>
                                <option value="">-- ƒêang t·∫£i danh s√°ch user... --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Ch·ªçn G√≥i T·∫≠p:</label>
                            <select id="selectPackage" class="form-select" required>
                                <option value="">-- ƒêang t·∫£i danh s√°ch g√≥i... --</option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√≠nh ng√†y h·∫øt h·∫°n d·ª±a tr√™n g√≥i ƒë√£ ch·ªçn.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveSubscription()">L∆∞u & K√≠ch Ho·∫°t</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const token = localStorage.getItem('gym_token');
        if (!token) window.location.href = '../../login.html';

        // --- H√ÄM 1: L·∫§Y DANH S√ÅCH ƒêƒÇNG K√ù ---
        async function fetchSubscriptions() {
            try {
                const response = await fetch('http://localhost/QLPG/public/api/subscriptions', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                renderTable(data.data);
            } catch (error) { console.error(error); }
        }

        function renderTable(subs) {
            const tbody = document.getElementById('subTableBody');
            tbody.innerHTML = '';
            
            if (!subs || subs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëƒÉng k√Ω n√†o.</td></tr>`;
                return;
            }

            subs.forEach(sub => {
                // Ki·ªÉm tra xem ƒë√£ h·∫øt h·∫°n ch∆∞a ƒë·ªÉ ƒë·ªïi m√†u
                const endDate = new Date(sub.end_date);
                const today = new Date();
                // N·∫øu ng√†y h·∫øt h·∫°n nh·ªè h∆°n h√¥m nay -> ƒê√£ h·∫øt h·∫°n
                const isExpired = endDate < today;
                
                const statusBadge = isExpired 
                    ? '<span class="badge bg-danger">H·∫øt h·∫°n</span>' 
                    : '<span class="badge bg-success">ƒêang ho·∫°t ƒë·ªông</span>';

                tbody.innerHTML += `
                    <tr>
                        <td>${sub.id}</td>
                        <td><strong>${sub.user ? sub.user.name : 'Kh√¥ng x√°c ƒë·ªãnh'}</strong></td>
                        <td><span class="badge bg-primary">${sub.package ? sub.package.name : 'Kh√¥ng x√°c ƒë·ªãnh'}</span></td>
                        <td>${sub.start_date}</td>
                        <td class="fw-bold">${sub.end_date}</td>
                        <td>${statusBadge}</td>
                    </tr>`;
            });
        }

        // --- H√ÄM 2: L·∫§Y DANH S√ÅCH USER & G√ìI ƒê·ªÇ ƒê·ªî V√ÄO SELECT ---
        // H√†m n√†y s·∫Ω ch·∫°y ngay khi b·∫•m n√∫t "Th√™m m·ªõi"
        async function loadOptions() {
            try {
                // 1. L·∫•y Users
                const resUsers = await fetch('http://localhost/QLPG/public/api/users', { headers: { 'Authorization': 'Bearer ' + token } });
                const dataUsers = await resUsers.json();
                
                // 2. L·∫•y Packages
                const resPackages = await fetch('http://localhost/QLPG/public/api/packages', { headers: { 'Authorization': 'Bearer ' + token } });
                const dataPackages = await resPackages.json();

                // 3. ƒê·ªï User v√†o Select
                const userSelect = document.getElementById('selectUser');
                userSelect.innerHTML = '<option value="">-- Ch·ªçn H·ªôi Vi√™n --</option>';
                dataUsers.data.forEach(u => {
                    // Ch·ªâ hi·ªán Member th∆∞·ªùng, PT c≈©ng c√≥ th·ªÉ mua g√≥i n·∫øu mu·ªën
                    userSelect.innerHTML += `<option value="${u.id}">${u.name} (ID: ${u.id})</option>`;
                });

                // 4. ƒê·ªï Package v√†o Select
                const pkgSelect = document.getElementById('selectPackage');
                pkgSelect.innerHTML = '<option value="">-- Ch·ªçn G√≥i T·∫≠p --</option>';
                dataPackages.data.forEach(p => {
                    pkgSelect.innerHTML += `<option value="${p.id}">${p.name} - ${p.duration_days} ng√†y (${p.price}ƒë)</option>`;
                });

            } catch (error) { console.error(error); }
        }

        // --- H√ÄM 3: L∆ØU ƒêƒÇNG K√ù M·ªöI ---
        async function saveSubscription() {
            const userId = document.getElementById('selectUser').value;
            const packageId = document.getElementById('selectPackage').value;

            if (!userId || !packageId) {
                alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß User v√† G√≥i!");
                return;
            }

            try {
                const response = await fetch('http://localhost/QLPG/public/api/subscriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        package_id: packageId
                    })
                });

                const result = await response.json();

                if (result.status) {
                    alert("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! H·∫°n d√πng ƒë·∫øn: " + result.data.end_date);
                    bootstrap.Modal.getInstance(document.getElementById('addSubModal')).hide();
                    fetchSubscriptions(); // T·∫£i l·∫°i b·∫£ng
                } else {
                    alert("L·ªói: " + result.message);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        function logout() { localStorage.removeItem('gym_token'); window.location.href = '../../login.html'; }

        // --- CH·∫†Y KHI V√ÄO TRANG ---
        fetchSubscriptions();
        loadOptions(); // T·∫£i s·∫µn danh s√°ch User/Package v√†o dropdown lu√¥n cho m∆∞·ª£t
    </script>
</body>
</html>