<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gym Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styleadmin.css">
    <style>
        .stat-card { cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .stat-card::after { content: 'Xem chi tiết →'; position: absolute; bottom: 5px; right: 15px; font-size: 10px; opacity: 0; transition: 0.3s; color: #888; }
        .stat-card:hover::after { opacity: 1; }
    </style>
</head>
<body style="display: none;" id="mainBody"> <div class="wrapper">
        <nav id="sidebar">
             <a href="../../index.html" class="logo">
                <div class="logo-icon">920</div>
                <div class="logo-text">Gym<span>Kayy</span></div>
            </a>
            <ul class="list-unstyled components">
                <li class="active"><a href="dashboard.html"><i class="fas fa-chart-pie"></i> Tổng Quan</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Hội Viên</a></li>
                <li><a href="packages.html"><i class="fas fa-box"></i> Gói Tập</a></li>
                <li><a href="subscriptions.html"><i class="fas fa-file-invoice"></i> Đăng Ký</a></li>
                <li><a href="bookings.html"><i class="fas fa-calendar-check"></i> Lịch Tập PT</a></li>
                <li><a href="schedules.html"><i class="fas fa-chalkboard-teacher"></i> Lớp Học</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
            </ul>
        </nav>

        <div id="content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0 fw-bold">Tổng Quan Hệ Thống</h2>
                <a href="users.html" class="btn btn-add">+ Thêm Hội Viên</a>
            </div>

            <div class="row">
                <div class="col-md-4 mb-4" onclick="showRevenueDetails()">
                    <div class="stat-card">
                        <div class="stat-info"><h5>Doanh Thu</h5><h3 id="revenue">0 đ</h3></div>
                        <div class="stat-icon icon-primary"><i class="fas fa-dollar-sign"></i></div>
                    </div>
                </div>
                <div class="col-md-4 mb-4" onclick="window.location.href='users.html'">
                    <div class="stat-card">
                        <div class="stat-info"><h5>Hội Viên</h5><h3 id="totalMembers">0</h3></div>
                        <div class="stat-icon icon-accent"><i class="fas fa-users"></i></div>
                    </div>
                </div>
                <div class="col-md-4 mb-4" onclick="showActivePackagesDetails()">
                    <div class="stat-card">
                        <div class="stat-info"><h5>Gói Đang Chạy</h5><h3 id="activeSubs">0</h3></div>
                        <div class="stat-icon icon-success"><i class="fas fa-dumbbell"></i></div>
                    </div>
                </div>
            </div>

            <div class="card-custom">
                <div class="card-header-custom"><h4 class="card-title">Khách Đăng Ký Gần Nhất</h4></div>
                <div class="table-responsive">
                    <table class="table table-dark-custom">
                        <thead>
                            <tr><th>Khách Hàng</th><th>Gói Tập</th><th>Ngày Đăng Ký</th><th>Trạng Thái</th></tr>
                        </thead>
                        <tbody id="recentTable">
                            <tr><td colspan="4" class="text-center py-4">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="revenueModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">Lịch Sử Đăng Ký Gói</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0"><div class="table-responsive"><table class="table mb-0"><thead class="table-light"><tr><th class="ps-3">Khách Hàng</th><th>Gói Mua</th><th>Giá Tiền</th><th>Ngày Mua</th></tr></thead><tbody id="revenueTableBody"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="activePackagesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">Gói Đang Hoạt Động</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0"><div class="table-responsive"><table class="table mb-0"><thead class="table-light"><tr><th class="ps-3">Khách Hàng</th><th>Tên Gói</th><th>Thời Hạn</th><th>Ngày Hết Hạn</th></tr></thead><tbody id="activePackagesTableBody"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- 1. CẤU HÌNH ĐƯỜNG DẪN TUYỆT ĐỐI ---
    // Thay đổi đường dẫn này đúng với thực tế thư mục của bạn
    const BASE_URL = 'http://localhost/QLPG/public'; 
    const LOGIN_PAGE = 'http://localhost/QLPG/app/http/public/frontend/login.html';
    const API_BASE_URL = `${BASE_URL}/api`;

    // --- 2. KIỂM TRA BẢO MẬT NGAY LẬP TỨC ---
    const token = localStorage.getItem('gym_token');

    if (!token || token === "null" || token === "undefined") {
        // Dừng mọi hoạt động xử lý khác của trình duyệt
        window.stop(); 
        localStorage.clear();
        // Chuyển hướng bằng đường dẫn tuyệt đối để không bị lỗi 404 dẫn đến lặp trang
        window.location.replace(LOGIN_PAGE);
    } else {
        // Chỉ hiển thị giao diện khi đã xác nhận có Token
        document.getElementById('mainBody').style.display = "block";
    }

    // --- 3. CÁC HÀM XỬ LÝ DỮ LIỆU ---
    async function loadStats() {
        try {
            const response = await fetch(`${API_BASE_URL}/dashboard-stats`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            // Nếu Token hết hạn hoặc không hợp lệ (Lỗi 401)
            if (response.status === 401) { logout(); return; }
            
            const res = await response.json();
            if (res.status) {
                const data = res.data;
                document.getElementById('revenue').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.revenue);
                document.getElementById('totalMembers').innerText = data.total_members + " người";
                document.getElementById('activeSubs').innerText = data.active_subs + " gói";

                const tbody = document.getElementById('recentTable');
                tbody.innerHTML = data.recent_subs.map(sub => `
                    <tr>
                        <td>${sub.user ? sub.user.name : '---'}</td>
                        <td><span class="badge bg-info text-dark">${sub.package ? sub.package.name : '---'}</span></td>
                        <td>${new Date(sub.created_at).toLocaleDateString('vi-VN')}</td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>`).join('');
            }
        } catch (error) { console.error("Lỗi tải thống kê:", error); }
    }

    async function showRevenueDetails() {
        const tbody = document.getElementById('revenueTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">Đang tải...</td></tr>';
        new bootstrap.Modal(document.getElementById('revenueModal')).show();
        
        try {
            const res = await fetch(`${API_BASE_URL}/dashboard-details?type=revenue`, { 
                headers: { 'Authorization': 'Bearer ' + token } 
            });
            const result = await res.json();
            if(result.status) {
                tbody.innerHTML = result.data.map(item => `
                    <tr>
                        <td class="ps-3 fw-bold">${item.user ? item.user.name : 'Ẩn danh'}</td>
                        <td><span class="badge bg-light text-dark border">${item.package ? item.package.name : '---'}</span></td>
                        <td class="text-success fw-bold">${new Intl.NumberFormat('vi-VN').format(item.package?.price || 0)} đ</td>
                        <td class="text-muted small">${new Date(item.created_at).toLocaleString('vi-VN')}</td>
                    </tr>`).join('');
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>'; }
    }

    async function showActivePackagesDetails() {
        const tbody = document.getElementById('activePackagesTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">Đang tải...</td></tr>';
        new bootstrap.Modal(document.getElementById('activePackagesModal')).show();
        
        try {
            const res = await fetch(`${API_BASE_URL}/dashboard-details?type=active_packages`, { 
                headers: { 'Authorization': 'Bearer ' + token } 
            });
            const result = await res.json();
            if(result.status) {
                tbody.innerHTML = result.data.map(item => {
                    const daysLeft = Math.ceil((new Date(item.end_date) - new Date()) / (1000 * 60 * 60 * 24));
                    return `
                        <tr>
                            <td class="ps-3 fw-bold">${item.user ? item.user.name : '---'}</td>
                            <td>${item.package ? item.package.name : '---'}</td>
                            <td>${item.package?.duration_days || 0} ngày</td>
                            <td>${new Date(item.end_date).toLocaleDateString('vi-VN')} <span class="badge bg-success">Còn ${daysLeft} ngày</span></td>
                        </tr>`;
                }).join('');
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>'; }
    }

    function logout() {
        localStorage.clear();
        window.location.replace(LOGIN_PAGE);
    }

    // Khởi chạy
    loadStats();
    </script>
</body>
</html>