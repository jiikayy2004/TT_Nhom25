<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gym Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styleadmin.css">
   
</head>
<body>

    <div class="wrapper">
        <nav id="sidebar">
            <a href="./index.html" class="logo">
                <div class="logo-icon">920</div>
                <div class="logo-text">Gym<span>Kayy</span></div>
            </a>

            <ul class="list-unstyled components">
                <li><a href="dashboard.html" class="active"><i class="fas fa-chart-pie"></i> Tổng Quan</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Hội Viên</a></li>
                <li><a href="packages.html"><i class="fas fa-box"></i> Gói Tập</a></li>
                <li><a href="subscriptions.html"><i class="fas fa-file-invoice"></i> Đăng Ký</a></li>
                
                <li><a href="bookings.html"><i class="fas fa-calendar-alt"></i> Lịch Tập PT</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
            </ul>
        </nav>

        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-dark bg-transparent mb-4 d-md-none">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-primary-custom">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span class="text-white fw-bold ms-3">DASHBOARD</span>
                </div>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0 fw-bold">Tổng Quan Hệ Thống</h2>
                <a href="users.html" class="btn btn-add">+ Thêm Hội Viên</a>
            </div>

            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h5>Doanh Thu</h5>
                            <h3 id="revenue">0 đ</h3>
                        </div>
                        <div class="stat-icon icon-primary"><i class="fas fa-dollar-sign"></i></div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h5>Hội Viên</h5>
                            <h3 id="totalMembers">0</h3>
                        </div>
                        <div class="stat-icon icon-accent"><i class="fas fa-users"></i></div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h5>Gói Đang Chạy</h5>
                            <h3 id="activeSubs">0</h3>
                        </div>
                        <div class="stat-icon icon-success"><i class="fas fa-dumbbell"></i></div>
                    </div>
                </div>
            </div>

            <div class="card-custom">
                <div class="card-header-custom">
                    <h4 class="card-title">Khách Đăng Ký Gần Nhất</h4>
                    <a href="subscriptions.html" class="btn btn-sm btn-outline-light">Xem tất cả</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark-custom">
                        <thead>
                            <tr>
                                <th>Khách Hàng</th>
                                <th>Gói Tập</th>
                                <th>Ngày Đăng Ký</th>
                                <th>Trạng Thái</th>
                            </tr>
                        </thead>
                        <tbody id="recentTable">
                            <tr><td colspan="4" class="text-center">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="overlay"></div>
    </div>

    <script>
        const token = localStorage.getItem('gym_token');
        if (!token) window.location.href = '../../login.html';

        async function loadStats() {
            try {
                const response = await fetch('http://localhost/QLPG/public/api/dashboard-stats', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const res = await response.json();

                if (res.status) {
                    const data = res.data;
                    
                    // 1. Cập nhật con số (Định dạng tiền tệ VNĐ)
                    const moneyFormat = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.revenue);
                    document.getElementById('revenue').innerText = moneyFormat;
                    
                    document.getElementById('totalMembers').innerText = data.total_members + " người";
                    document.getElementById('activeSubs').innerText = data.active_subs + " gói";

                    // 2. Cập nhật bảng bên dưới
                    const tbody = document.getElementById('recentTable');
                    tbody.innerHTML = '';
                    
                    data.recent_subs.forEach(sub => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${sub.user ? sub.user.name : 'Unknown'}</td>
                                <td><span class="badge bg-info text-dark">${sub.package ? sub.package.name : 'Unknown'}</span></td>
                                <td>${sub.created_at ? new Date(sub.created_at).toLocaleDateString('vi-VN') : 'N/A'}</td>
                                <td><span class="badge bg-success">Active</span></td>
                            </tr>
                        `;
                    });
                }
            } catch (error) { console.error(error); }
        }

        function logout() {
            localStorage.removeItem('gym_token');
            window.location.href = '../../login.html';
        }

        loadStats();
    </script>
</body>
</html>