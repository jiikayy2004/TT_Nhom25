<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω G√≥i T·∫≠p - Gym Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { display: flex; height: 100vh; overflow: hidden; background: #f8f9fa; }
        .sidebar { width: 250px; background: #343a40; color: white; flex-shrink: 0; }
        .sidebar a { color: #cfd2d6; text-decoration: none; display: block; padding: 15px; border-bottom: 1px solid #4b545c; }
        .sidebar a:hover, .sidebar a.active { background: #007bff; color: white; }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .table-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="text-center py-3 border-bottom">GYM MASTER</h3>
        <a href="dashboard.html">üìä T·ªïng Quan</a>
        <a href="users.html">üë• Qu·∫£n L√Ω H·ªôi Vi√™n</a>
        <a href="packages.html" class="active">üì¶ Qu·∫£n L√Ω G√≥i T·∫≠p</a>
        <a href="#" onclick="logout()">üö™ ƒêƒÉng Xu·∫•t</a>
    </div>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Qu·∫£n L√Ω G√≥i T·∫≠p</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPackageModal">
                <i class="fas fa-plus"></i> Th√™m G√≥i M·ªõi
            </button>
        </div>

        <div class="table-box">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>T√™n G√≥i</th>
                        <th>Gi√° Ti·ªÅn</th>
                        <th>Th·ªùi H·∫°n</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="packageTableBody">
                    <tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="addPackageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">T·∫°o G√≥i T·∫≠p M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPackageForm">
                        <div class="mb-3">
                            <label>T√™n G√≥i T·∫≠p:</label>
                            <input type="text" id="packageName" class="form-control" placeholder="V√≠ d·ª•: G√≥i 1 Th√°ng" required>
                        </div>
                        <div class="mb-3">
                            <label>Gi√° Ti·ªÅn (VNƒê):</label>
                            <input type="number" id="packagePrice" class="form-control" placeholder="500000" required>
                        </div>
                        <div class="mb-3">
                            <label>Th·ªùi H·∫°n (Ng√†y):</label>
                            <input type="number" id="packageDuration" class="form-control" placeholder="30" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewPackage()">L∆∞u L·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPackageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ch·ªânh S·ª≠a G√≥i T·∫≠p</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPackageForm">
                        <input type="hidden" id="editPackageId">
                        
                        <div class="mb-3">
                            <label>T√™n G√≥i T·∫≠p:</label>
                            <input type="text" id="editPackageName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Gi√° Ti·ªÅn (VNƒê):</label>
                            <input type="number" id="editPackagePrice" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Th·ªùi H·∫°n (Ng√†y):</label>
                            <input type="number" id="editPackageDuration" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-warning" onclick="updatePackage()">L∆∞u Thay ƒê·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem('gym_token');
        if (!token) window.location.href = '../../login.html';

        // --- H√ÄM 1: L·∫§Y DANH S√ÅCH G√ìI T·∫¨P ---
        async function fetchPackages() {
            try {
                // G·ªçi API GET /packages
                const response = await fetch('http://localhost/QLPG/public/api/packages', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                renderTable(data.data);
            } catch (error) { console.error(error); }
        }
        

        // --- H√ÄM 2: V·∫º B·∫¢NG G√ìI T·∫¨P ---
        function renderTable(packages) {
            const tbody = document.getElementById('packageTableBody');
            tbody.innerHTML = '';
            
            if (!packages || packages.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ g√≥i t·∫≠p n√†o</td></tr>`;
                return;
            }

            packages.forEach(pkg => {
                // M·∫πo: D√πng Intl.NumberFormat ƒë·ªÉ bi·∫øn s·ªë 500000 th√†nh chu·ªói "500.000" (c√≥ d·∫•u ch·∫•m)
                const priceFormatted = new Intl.NumberFormat('vi-VN').format(pkg.price);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${pkg.id}</td>
                        <td><strong>${pkg.name}</strong></td>
                        <td class="text-success fw-bold">${priceFormatted} ƒë</td>
                        <td>${pkg.duration_days} ng√†y</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deletePackage(${pkg.id})">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </td>
                    </tr>`;
            });
            
        }
        function renderTable(packages) {
        const tbody = document.getElementById('packageTableBody');
        tbody.innerHTML = ''; // X√≥a s·∫°ch d·ªØ li·ªáu c≈©

        if (!packages || packages.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ g√≥i t·∫≠p n√†o</td></tr>`;
        return;
        }

        packages.forEach(pkg => {
        
        const priceFormatted = new Intl.NumberFormat('vi-VN').format(pkg.price);
        
        
        const row = `
            <tr>
                <td>${pkg.id}</td>
                <td><strong>${pkg.name}</strong></td>
                <td class="text-success fw-bold">${priceFormatted} ƒë</td>
                <td>${pkg.duration_days} ng√†y</td>
                <td>
                    <button class="btn btn-sm btn-warning" 
                        onclick="openEditPackageModal(${pkg.id}, '${pkg.name}', ${pkg.price}, ${pkg.duration_days})">
                        <i class="fas fa-edit"></i>
                    </button>

                    <button class="btn btn-sm btn-danger" onclick="deletePackage(${pkg.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            
        tbody.innerHTML += row;
    });
}

        // --- H√ÄM 3: TH√äM G√ìI M·ªöI ---
        async function saveNewPackage() {
            // L·∫•y d·ªØ li·ªáu t·ª´ 3 √¥ input
            const data = {
                name: document.getElementById('packageName').value,
                price: document.getElementById('packagePrice').value,
                duration_days: document.getElementById('packageDuration').value
            };
            
            try {
                // G·ªçi API POST /packages
                const response = await fetch('http://localhost/QLPG/public/api/packages', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status) {
                    alert("‚úÖ Th√†nh c√¥ng!");
                    bootstrap.Modal.getInstance(document.getElementById('addPackageModal')).hide();
                    document.getElementById('addPackageForm').reset();
                    fetchPackages(); // T·∫£i l·∫°i b·∫£ng ngay
                } else { alert("L·ªói: " + result.message); }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }
        

        // --- H√ÄM 4: X√ìA G√ìI ---
        async function deletePackage(id) {
            if(!confirm("X√≥a g√≥i n√†y?")) return;
            try {
                // G·ªçi API DELETE /packages/{id}
                await fetch(`http://localhost/QLPG/public/api/packages/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                fetchPackages();
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }
        

        function logout() { localStorage.removeItem('gym_token'); window.location.href = '../../login.html'; }

        // Ch·∫°y ngay khi v√†o trang
        fetchPackages();

        // --- H√ÄM 5: M·ªû MODAL S·ª¨A (ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form) ---
        function openEditPackageModal(id, name, price, duration) {
            document.getElementById('editPackageId').value = id;
            document.getElementById('editPackageName').value = name;
            document.getElementById('editPackagePrice').value = price;
            document.getElementById('editPackageDuration').value = duration;

            const modal = new bootstrap.Modal(document.getElementById('editPackageModal'));
            modal.show();
        }

        // --- H√ÄM 6: L∆ØU C·∫¨P NH·∫¨T (G·ª≠i l√™n Server) ---
        async function updatePackage() {
            const id = document.getElementById('editPackageId').value;
            const data = {
                name: document.getElementById('editPackageName').value,
                price: document.getElementById('editPackagePrice').value,
                duration_days: document.getElementById('editPackageDuration').value
            };

            try {
                const response = await fetch(`http://localhost/QLPG/public/api/packages/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status) {
                    alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    // ·∫®n modal
                    const modalEl = document.getElementById('editPackageModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    
                    fetchPackages();
                } else {
                    alert("L·ªói: " + result.message);
                }
            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi Server!");
            }
        }

        function logout() { localStorage.removeItem('gym_token'); window.location.href = '../../login.html'; }

        fetchPackages();
    </script>
</body>
</html>