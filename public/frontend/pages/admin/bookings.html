<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªãch T·∫≠p - Gym Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { display: flex; height: 100vh; overflow: hidden; background: #f8f9fa; }
        .sidebar { width: 250px; background: #343a40; color: white; flex-shrink: 0; }
        .sidebar a { color: #cfd2d6; text-decoration: none; display: block; padding: 15px; border-bottom: 1px solid #4b545c; }
        .sidebar a:hover, .sidebar a.active { background: #007bff; color: white; }
        .content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .table-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="text-center py-3 border-bottom">GYM MASTER</h3>
        <a href="dashboard.html">üìä T·ªïng Quan</a>
        <a href="users.html">üë• Qu·∫£n L√Ω H·ªôi Vi√™n</a>
        <a href="packages.html">üì¶ Qu·∫£n L√Ω G√≥i T·∫≠p</a>
        <a href="subscriptions.html">üìù ƒêƒÉng K√Ω G√≥i</a>
        <a href="bookings.html" class="active">üìÖ L·ªãch T·∫≠p PT</a>
        <a href="#" onclick="logout()">üö™ ƒêƒÉng Xu·∫•t</a>
    </div>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>L·ªãch T·∫≠p V·ªõi PT</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookingModal">
                <i class="fas fa-plus"></i> ƒê·∫∑t L·ªãch M·ªõi
            </button>
        </div>

        <div class="table-box">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>H·ªôi Vi√™n</th>
                        <th>PT H∆∞·ªõng D·∫´n</th>
                        <th>Th·ªùi Gian T·∫≠p</th>
                        <th>Ghi Ch√∫</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="bookingTableBody">
                    <tr><td colspan="7" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="addBookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ƒê·∫∑t L·ªãch T·∫≠p M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addBookingForm">
                        <div class="mb-3">
                            <label>Kh√°ch H√†ng:</label>
                            <select id="selectUser" class="form-select" required>
                                <option value="">-- ƒêang t·∫£i... --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Ch·ªçn PT:</label>
                            <select id="selectPT" class="form-select" required>
                                <option value="">-- ƒêang t·∫£i... --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Th·ªùi Gian T·∫≠p:</label>
                            <input type="datetime-local" id="scheduleTime" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Ghi Ch√∫ (B√†i t·∫≠p, y√™u c·∫ßu...):</label>
                            <textarea id="note" class="form-control" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="saveBooking()">G·ª≠i Y√™u C·∫ßu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem('gym_token');
        if (!token) window.location.href = '../../login.html';

        // --- H√ÄM 1: L·∫§Y DANH S√ÅCH L·ªäCH ---
        async function fetchBookings() {
            try {
                const response = await fetch('http://localhost/QLPG/public/api/bookings', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                renderTable(data.data);
            } catch (error) { console.error(error); }
        }

        function renderTable(bookings) {
            const tbody = document.getElementById('bookingTableBody');
            tbody.innerHTML = '';
            
            if (!bookings || bookings.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ l·ªãch ƒë·∫∑t n√†o.</td></tr>`;
                return;
            }

            bookings.forEach(bk => {
                // ƒê·ªãnh d·∫°ng ng√†y gi·ªù cho ƒë·∫πp (V√≠ d·ª•: 20:00 25/12/2025)
                const time = new Date(bk.schedule_time).toLocaleString('vi-VN');
                
                // M√†u s·∫Øc tr·∫°ng th√°i
                let statusBadge = '';
                let actionButtons = '';

                if(bk.status === 'pending') {
                    statusBadge = '<span class="badge bg-warning text-dark">Ch·ªù Duy·ªát</span>';
                    // N·∫øu ƒëang ch·ªù, hi·ªán n√∫t Duy·ªát/T·ª´ ch·ªëi
                    actionButtons = `
                        <button class="btn btn-sm btn-success" onclick="updateStatus(${bk.id}, 'confirmed')" title="ƒê·ªìng √Ω"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="updateStatus(${bk.id}, 'rejected')" title="T·ª´ ch·ªëi"><i class="fas fa-times"></i></button>
                    `;
                } else if (bk.status === 'confirmed') {
                    statusBadge = '<span class="badge bg-success">ƒê√£ Duy·ªát</span>';
                    actionButtons = '<small class="text-success"><i class="fas fa-check-circle"></i> Xong</small>';
                } else {
                    statusBadge = '<span class="badge bg-secondary">ƒê√£ H·ªßy/T·ª´ ch·ªëi</span>';
                    actionButtons = '<small class="text-muted">---</small>';
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${bk.id}</td>
                        <td><strong>${bk.user ? bk.user.name : 'Unknown'}</strong></td>
                        <td><span class="badge bg-info text-dark">${bk.pt ? bk.pt.name : 'Unknown'}</span></td>
                        <td class="fw-bold">${time}</td>
                        <td>${bk.note || ''}</td>
                        <td>${statusBadge}</td>
                        <td>${actionButtons}</td>
                    </tr>`;
            });
        }

        // --- H√ÄM 2: L·∫§Y DANH S√ÅCH NG∆Ø·ªúI D√ôNG ƒê·ªÇ ƒê·ªî V√ÄO SELECT ---
        async function loadOptions() {
            try {
                const response = await fetch('http://localhost/QLPG/public/api/users', { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                const data = await response.json();

                const selectUser = document.getElementById('selectUser');
                const selectPT = document.getElementById('selectPT');

                selectUser.innerHTML = '<option value="">-- Ch·ªçn Kh√°ch --</option>';
                selectPT.innerHTML = '<option value="">-- Ch·ªçn PT --</option>';

                data.data.forEach(u => {
                    // ƒê·ªï v√†o √¥ Kh√°ch h√†ng (Ai c≈©ng c√≥ th·ªÉ l√† kh√°ch)
                    selectUser.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                    
                    // ƒê·ªï v√†o √¥ PT (Ch·ªâ ng∆∞·ªùi c√≥ role='pt')
                    if(u.role === 'pt') {
                        selectPT.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                    }
                });
            } catch (error) { console.error(error); }
        }

        // --- H√ÄM 3: G·ª¨I L·ªäCH ƒê·∫∂T M·ªöI ---
        async function saveBooking() {
            const data = {
                user_id: document.getElementById('selectUser').value,
                pt_id: document.getElementById('selectPT').value,
                schedule_time: document.getElementById('scheduleTime').value,
                note: document.getElementById('note').value
            };

            if(!data.user_id || !data.pt_id || !data.schedule_time) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!"); return;
            }

            try {
                const response = await fetch('http://localhost/QLPG/public/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if(result.status) {
                    alert("‚úÖ " + result.message);
                    bootstrap.Modal.getInstance(document.getElementById('addBookingModal')).hide();
                    fetchBookings();
                } else {
                    alert("‚ùå L·ªói: " + result.message);
                }
            } catch(e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // --- H√ÄM 4: DUY·ªÜT / T·ª™ CH·ªêI L·ªäCH ---
        async function updateStatus(id, newStatus) {
            if(!confirm(newStatus === 'confirmed' ? "Duy·ªát l·ªãch t·∫≠p n√†y?" : "T·ª´ ch·ªëi l·ªãch t·∫≠p n√†y?")) return;

            try {
                const response = await fetch(`http://localhost/QLPG/public/api/bookings/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                fetchBookings(); // Load l·∫°i b·∫£ng ƒë·ªÉ th·∫•y tr·∫°ng th√°i m·ªõi
            } catch(e) { alert("L·ªói x·ª≠ l√Ω!"); }
        }

        function logout() { localStorage.removeItem('gym_token'); window.location.href = '../../login.html'; }

        // Ch·∫°y khi m·ªü trang
        fetchBookings();
        loadOptions();
    </script>
</body>
</html>