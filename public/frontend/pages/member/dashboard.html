<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang H·ªôi Vi√™n - Gym Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/style.css">
    
</head>
<body>

    <header>
        <nav>
            <a href="../../index.html" class="logo">
                <div class="logo-icon">920</div>
                <div class="logo-text">Gym<span>Kayy</span></div>
            </a>
            <ul class="nav-menu">
                <li><a href="../../index.html">Trang ch·ªß</a></li>
                <li><a href="../../index.html#packages">G√≥i t·∫≠p</a></li>
                <li><a href="../../index.html#promotions">Khuy·∫øn m√£i</a></li>
            </ul>
            <div class="nav-actions">
                <div class="welcome" id="welcomeMsg">Xin ch√†o...</div>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</button>
            </div>
        </nav>
    </header>

    <div class="container py-5" style="margin-top:110px;">
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom p-4">
                    <h5 class="border-bottom pb-3 text-uppercase text-muted fw-bold"><i class="fas fa-id-card-alt"></i> G√≥i T·∫≠p C·ªßa T√¥i</h5>
                    <div id="subscriptionInfo" class="mt-3">
                        <div class="d-flex align-items-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2"></div> ƒêang t·∫£i th√¥ng tin...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card card-custom p-4">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-3">
                        <h5 class="text-uppercase text-muted fw-bold m-0"><i class="fas fa-calendar-check"></i> L·ªãch H·∫πn V·ªõi PT</h5>
                        <button class="btn btn-booking rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#bookingModal" onclick="loadPTList()">
                            <i class="fas fa-plus-circle"></i> ƒê·∫∑t L·ªãch M·ªõi
                        </button>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>PT H∆∞·ªõng D·∫´n</th>
                                    <th>Th·ªùi Gian</th>
                                    <th>Ghi Ch√∫</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                </tr>
                            </thead>
                            <tbody id="myBookings">
                                <tr><td colspan="4" class="text-center text-muted">ƒêang t·∫£i l·ªãch s·ª≠...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üìÖ ƒê·∫∑t L·ªãch T·∫≠p</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <div class="mb-3">
                            <label class="fw-bold">Ch·ªçn Hu·∫•n Luy·ªán Vi√™n (PT):</label>
                            <select id="selectPT" class="form-select" required>
                                <option value="">-- ƒêang t·∫£i danh s√°ch PT... --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Th·ªùi Gian T·∫≠p:</label>
                            <input type="datetime-local" id="scheduleTime" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Ghi Ch√∫ (B√†i t·∫≠p mong mu·ªën):</label>
                            <textarea id="note" class="form-control" rows="2" placeholder="V√≠ d·ª•: T·∫≠p ch√¢n, Cardio..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="submitBooking()">G·ª≠i Y√™u C·∫ßu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem('gym_token');
        const user = JSON.parse(localStorage.getItem('gym_user') || '{}');

        // B·∫£o v·ªá trang: Ch∆∞a ƒëƒÉng nh·∫≠p ƒëu·ªïi v·ªÅ ngay
        if (!token) window.location.href = '../../login.html';

        // Hi·ªÉn th·ªã t√™n User tr√™n thanh menu
        document.getElementById('welcomeMsg').innerText = `Xin ch√†o, ${user.name || 'H·ªôi vi√™n'}`;

        // --- H√ÄM 1: L·∫§Y G√ìI T·∫¨P HI·ªÜN T·∫†I ---
        async function loadMySubscription() {
            try {
                // T·ª± check-in ch√≠nh m√¨nh ƒë·ªÉ l·∫•y th√¥ng tin g√≥i
                const response = await fetch('http://localhost/QLPG/public/api/check-in', {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ search_query: user.id }) 
                });
                
                const data = await response.json();
                const infoDiv = document.getElementById('subscriptionInfo');

                if (data.status) {
                    const sub = data.data.subscription;
                    const daysLeft = data.data.days_left;
                    infoDiv.innerHTML = `
                        <div class="alert alert-success border-0 shadow-sm">
                            <div class="d-flex align-items-center">
                                <div class="fs-1 me-3"><i class="fas fa-check-circle text-success"></i></div>
                                <div>
                                    <h5 class="fw-bold mb-1">${sub.package.name}</h5>
                                    <p class="mb-0 text-muted">H·∫øt h·∫°n: <b>${sub.end_date}</b> (C√≤n <span class="text-primary fw-bold">${daysLeft} ng√†y</span>)</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="alert alert-warning border-0 shadow-sm">
                            <i class="fas fa-exclamation-triangle"></i> B·∫°n ch∆∞a c√≥ g√≥i t·∫≠p n√†o ƒëang ho·∫°t ƒë·ªông. Vui l√≤ng li√™n h·ªá L·ªÖ t√¢n.
                        </div>`;
                }
            } catch (error) { console.error(error); }
        }

        // --- H√ÄM 2: L·∫§Y DANH S√ÅCH PT (ƒê·ªÉ ƒë·ªï v√†o Dropdown khi ƒë·∫∑t l·ªãch) ---
        async function loadPTList() {
            const selectPT = document.getElementById('selectPT');
            // N·∫øu ƒë√£ t·∫£i r·ªìi th√¨ kh√¥ng t·∫£i l·∫°i cho ƒë·ª° lag
            if(selectPT.options.length > 1) return; 

            try {
                const response = await fetch('http://localhost/QLPG/public/api/users', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                selectPT.innerHTML = '<option value="">-- Ch·ªçn PT --</option>';
                
                // L·ªçc: Ch·ªâ l·∫•y nh·ªØng ng∆∞·ªùi c√≥ role l√† 'pt'
                data.data.forEach(u => {
                    if(u.role === 'pt') {
                        selectPT.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                    }
                });
            } catch (e) { console.error(e); }
        }

        // --- H√ÄM 3: G·ª¨I Y√äU C·∫¶U ƒê·∫∂T L·ªäCH ---
        async function submitBooking() {
            const ptId = document.getElementById('selectPT').value;
            const time = document.getElementById('scheduleTime').value;
            const note = document.getElementById('note').value;

            if(!ptId || !time) {
                alert("Vui l√≤ng ch·ªçn PT v√† Th·ªùi gian!"); return;
            }

            try {
                const response = await fetch('http://localhost/QLPG/public/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: user.id, // L·∫•y ID c·ªßa ch√≠nh m√¨nh
                        pt_id: ptId,
                        schedule_time: time,
                        note: note
                    })
                });

                const result = await response.json();
                if(result.status) {
                    alert("‚úÖ ƒê·∫∑t l·ªãch th√†nh c√¥ng! Vui l√≤ng ch·ªù PT x√°c nh·∫≠n.");
                    // T·∫Øt Modal
                    bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
                    // T·∫£i l·∫°i danh s√°ch l·ªãch
                    loadMyBookings();
                } else {
                    alert("‚ùå L·ªói: " + result.message);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // --- H√ÄM 4: L·∫§Y L·ªäCH S·ª¨ ƒê·∫∂T L·ªäCH C·ª¶A T√îI ---
        async function loadMyBookings() {
            try {
                const response = await fetch('http://localhost/QLPG/public/api/bookings', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                const tbody = document.getElementById('myBookings');
                tbody.innerHTML = '';

                // L·ªçc: Ch·ªâ l·∫•y l·ªãch C·ª¶A T√îI
                const mySchedule = data.data.filter(bk => bk.user_id == user.id);

                if (mySchedule.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">B·∫°n ch∆∞a c√≥ l·ªãch h·∫πn n√†o.</td></tr>';
                    return;
                }

                mySchedule.forEach(bk => {
                    const time = new Date(bk.schedule_time).toLocaleString('vi-VN');
                    let status = '<span class="badge bg-warning text-dark">Ch·ªù duy·ªát</span>';
                    if(bk.status === 'confirmed') status = '<span class="badge bg-success">ƒê√£ duy·ªát</span>';
                    if(bk.status === 'rejected') status = '<span class="badge bg-danger">B·ªã t·ª´ ch·ªëi</span>';

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${bk.pt ? bk.pt.name : 'Unknown'}</strong></td>
                            <td>${time}</td>
                            <td>${bk.note || ''}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                });
            } catch (error) { console.error(error); }
        }

        function logout() {
            localStorage.removeItem('gym_token');
            localStorage.removeItem('gym_user');
            window.location.href = '../../login.html';
        }

        // Ch·∫°y khi t·∫£i trang
        loadMySubscription();
        loadMyBookings();
    </script>
</body>
</html>