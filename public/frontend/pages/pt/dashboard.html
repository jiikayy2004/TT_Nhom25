<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>

    <div class="wrapper">
        <nav id="sidebar">
            <div class="brand">PT ZONE</div>
            <ul>
                <li><a href="#" class="active"><i class="fas fa-calendar-check"></i> L·ªãch D·∫°y</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </nav>

        <div id="content">
            <h2 class="page-title" id="welcomeMsg">Xin ch√†o PT</h2>
            
            <div class="alert alert-info mt-3">
                <strong>üîß Th√¥ng tin g·ª° l·ªói:</strong><br>
                - ID c·ªßa b·∫°n: <strong id="debug-my-id">...</strong><br>
                - T·ªïng s·ªë l·ªãch tr√™n h·ªá th·ªëng: <strong id="debug-total">...</strong><br>
                - S·ªë l·ªãch kh·ªõp v·ªõi b·∫°n: <strong id="debug-match">...</strong>
            </div>

            <div class="card-dark mt-4">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Danh S√°ch Y√™u C·∫ßu</h4>
                    <button class="btn btn-sm btn-primary" onclick="loadSchedule()">L√†m m·ªõi</button>
                </div>
                <div class="table-responsive">
                    <table class="table-dark-custom" style="width:100%">
                        <thead>
                            <tr>
                                <th>H·ªçc Vi√™n</th>
                                <th>Gi·ªù T·∫≠p</th>
                                <th>Ghi Ch√∫</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>H√†nh ƒê·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <tr><td colspan="5">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    
    <script>
        // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        const token = localStorage.getItem('gym_token');
        const user = JSON.parse(localStorage.getItem('gym_user') || '{}');

        if (!token || user.role !== 'pt') {
            alert("B·∫°n kh√¥ng ph·∫£i l√† PT ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p!");
            window.location.href = '../../login.html';
        }

        document.getElementById('welcomeMsg').innerText = `Xin ch√†o HLV ${user.name}`;
        document.getElementById('debug-my-id').innerText = user.id; // Hi·ªÉn th·ªã ID c·ªßa PT ƒë·ªÉ check

        // 2. T·∫£i l·ªãch t·∫≠p
        async function loadSchedule() {
            try {
                const res = await fetch(`${API_URL}/bookings`, { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                const data = await res.json();
                
                // Debug th√¥ng tin
                document.getElementById('debug-total').innerText = data.data.length;

                const tbody = document.getElementById('scheduleBody');
                tbody.innerHTML = '';

                // L·ªåC: Ch·ªâ l·∫•y l·ªãch c√≥ pt_id tr√πng v·ªõi ID c·ªßa ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p
                const mySchedule = data.data.filter(bk => bk.pt_id == user.id);
                document.getElementById('debug-match').innerText = mySchedule.length;

                if (mySchedule.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Kh√¥ng t√¨m th·∫•y l·ªãch n√†o cho b·∫°n.</td></tr>';
                    return;
                }

                // V·∫Ω b·∫£ng
                mySchedule.forEach(bk => {
                    let statusHtml = '';
                    let actionHtml = '';

                    // X·ª≠ l√Ω tr·∫°ng th√°i v√† n√∫t b·∫•m
                    if (bk.status === 'pending') {
                        statusHtml = '<span class="badge bg-warning text-dark">Ch·ªù duy·ªát</span>';
                        actionHtml = `
                            <button class="btn btn-sm btn-success" onclick="updateStatus(${bk.id}, 'confirmed')">‚úî Duy·ªát</button>
                            <button class="btn btn-sm btn-danger" onclick="updateStatus(${bk.id}, 'rejected')">‚úñ T·ª´ ch·ªëi</button>
                        `;
                    } else if (bk.status === 'confirmed') {
                        statusHtml = '<span class="badge bg-success">ƒê√£ nh·∫≠n</span>';
                        actionHtml = '<span class="text-success"><i class="fas fa-check"></i> Xong</span>';
                    } else {
                        statusHtml = '<span class="badge bg-danger">ƒê√£ t·ª´ ch·ªëi</span>';
                        actionHtml = '-';
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${bk.user ? bk.user.name : 'Unknown'}</td>
                            <td>${new Date(bk.schedule_time).toLocaleString('vi-VN')}</td>
                            <td>${bk.note || ''}</td>
                            <td>${statusHtml}</td>
                            <td>${actionHtml}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error(error);
                alert("L·ªói t·∫£i d·ªØ li·ªáu!");
            }
        }

        // 3. C·∫≠p nh·∫≠t tr·∫°ng th√°i (Duy·ªát/T·ª´ ch·ªëi)
        async function updateStatus(id, newStatus) {
            if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?")) return;

            try {
                const res = await fetch(`${API_URL}/bookings/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    loadSchedule(); // T·∫£i l·∫°i b·∫£ng
                } else {
                    alert("L·ªói c·∫≠p nh·∫≠t!");
                }
            } catch (e) { console.error(e); }
        }

        function logout() {
            localStorage.removeItem('gym_token');
            localStorage.removeItem('gym_user');
            window.location.href = '../../login.html';
        }

        // Ch·∫°y ngay khi v√†o trang
        loadSchedule();
    </script>
</body>
</html>