<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khu V·ª±c PT - Gym Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./ptstyle.css">
</head>
<body>

    <div class="wrapper">
        <nav id="sidebar">
            <div class="brand">PT ZONE</div>
            <ul>
                <li><a href="#" class="active"><i class="fas fa-calendar-check"></i> L·ªãch D·∫°y</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </nav>

        <div id="content">
            <div class="d-md-none mb-3 d-flex align-items-center">
                <button id="sidebarToggle" class="btn btn-neon me-3"><i class="fas fa-bars"></i></button>
                <h4 class="m-0 fw-bold">PT DASHBOARD</h4>
            </div>

            <div class="page-header">
                <h2 class="page-title" id="welcomeMsg">Xin ch√†o PT...</h2>
                <div class="text-muted">Qu·∫£n l√Ω l·ªãch d·∫°y c·ªßa b·∫°n</div>
            </div>

            <div class="alert alert-dark mt-3" style="border: 1px solid #334155;">
                <small class="text-muted">üîß Debug Info:</small><br>
                <span>ID C·ªßa B·∫°n: <b id="debug-id" class="text-warning">...</b></span> | 
                <span>T·ªïng L·ªãch T√¨m Th·∫•y: <b id="debug-count" class="text-info">...</b></span>
            </div>

            <div class="card-dark mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="m-0">üìÖ Danh S√°ch Y√™u C·∫ßu</h4>
                    <button class="btn btn-sm btn-outline-light" onclick="loadMySchedule()">
                        <i class="fas fa-sync"></i> L√†m m·ªõi
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table-dark-custom">
                        <thead>
                            <tr>
                                <th>H·ªçc Vi√™n</th>
                                <th>Th·ªùi Gian</th>
                                <th>Ghi Ch√∫</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th>H√†nh ƒê·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="overlay"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. C·∫§U H√åNH ---
        const API_URL = 'http://localhost/QLPG/public/api'; // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y ƒë√∫ng v·ªõi m√°y b·∫°n

        // --- 2. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ---
        const token = localStorage.getItem('gym_token');
        const userStr = localStorage.getItem('gym_user');

        if (!token || !userStr) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
            window.location.href = '../../login.html';
        }

        const user = JSON.parse(userStr);
        
        // Ki·ªÉm tra quy·ªÅn (Ch·ªâ PT m·ªõi ƒë∆∞·ª£c v√†o)
        if (user.role !== 'pt') {
            alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!");
            window.location.href = '../../login.html';
        }

        // Hi·ªÉn th·ªã th√¥ng tin
        document.getElementById('welcomeMsg').innerText = `Xin ch√†o HLV ${user.name}`;
        document.getElementById('debug-id').innerText = user.id;

        // --- 3. X·ª¨ L√ù SIDEBAR MOBILE ---
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        const btnToggle = document.getElementById('sidebarToggle');
        const wrapper = document.querySelector('.wrapper');
        
        if(btnToggle) {
            btnToggle.addEventListener('click', () => { 
                wrapper.classList.add('active'); 
            });
            overlay.addEventListener('click', () => { 
                wrapper.classList.remove('active'); 
            });
        }

        // --- 4. T·∫¢I L·ªäCH D·∫†Y ---
        async function loadMySchedule() {
            try {
                // G·ªçi API
                const res = await fetch(`${API_URL}/bookings`, { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                
                const data = await res.json();
                
                // Debug d·ªØ li·ªáu ra Console (·∫§n F12 ƒë·ªÉ xem n·∫øu l·ªói)
                console.log("D·ªØ li·ªáu t·ª´ Server:", data);

                const tbody = document.getElementById('scheduleBody');
                tbody.innerHTML = '';

                if (!data.data) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">L·ªói c·∫•u tr√∫c d·ªØ li·ªáu!</td></tr>';
                    return;
                }

                // L·ªåC: Ch·ªâ l·∫•y l·ªãch c√≥ pt_id tr√πng v·ªõi ID c·ªßa ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p
                const mySchedule = data.data.filter(bk => bk.pt_id == user.id);
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t√¨m th·∫•y
                document.getElementById('debug-count').innerText = mySchedule.length;

                if (mySchedule.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ l·ªãch d·∫°y n√†o ƒë∆∞·ª£c ph√¢n c√¥ng cho b·∫°n.</td></tr>';
                    return;
                }

                // S·∫Øp x·∫øp: M·ªõi nh·∫•t l√™n ƒë·∫ßu
                mySchedule.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                mySchedule.forEach(bk => {
                    let actions = '';
                    let statusBadge = '';

                    // X·ª≠ l√Ω hi·ªÉn th·ªã theo tr·∫°ng th√°i
                    if (bk.status === 'pending') {
                        statusBadge = '<span class="badge-status bg-warning text-dark">Ch·ªù duy·ªát</span>';
                        actions = `
                            <button class="btn-icon text-success border-success me-2" onclick="updateStatus(${bk.id}, 'confirmed')" title="ƒê·ªìng √Ω">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon text-danger border-danger" onclick="updateStatus(${bk.id}, 'rejected')" title="T·ª´ ch·ªëi">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else if (bk.status === 'confirmed') {
                        statusBadge = '<span class="badge-status bg-success">ƒê√£ nh·∫≠n</span>';
                        actions = '<span class="text-success small"><i class="fas fa-check-circle"></i> ƒê√£ nh·∫≠n</span>';
                    } else {
                        statusBadge = '<span class="badge-status bg-expired">ƒê√£ t·ª´ ch·ªëi</span>';
                        actions = '-';
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold text-white">${bk.user ? bk.user.name : 'Unknown'}</td>
                            <td>
                                <div>${new Date(bk.schedule_time).toLocaleDateString('vi-VN')}</div>
                                <small class="text-muted">${new Date(bk.schedule_time).toLocaleTimeString('vi-VN')}</small>
                            </td>
                            <td>${bk.note || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${actions}</td>
                        </tr>`;
                });

            } catch (e) { 
                console.error("L·ªñI:", e);
                document.getElementById('scheduleBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">L·ªói k·∫øt n·ªëi: ${e.message}</td></tr>`;
                alert("L·ªói t·∫£i d·ªØ li·ªáu! H√£y nh·∫•n F12 ch·ªçn tab Console ƒë·ªÉ xem chi ti·∫øt.");
            }
        }

        // --- 5. C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI ---
        async function updateStatus(bookingId, newStatus) {
            const confirmMsg = newStatus === 'confirmed' ? "B·∫°n mu·ªën NH·∫¨N l·ªãch n√†y?" : "B·∫°n mu·ªën T·ª™ CH·ªêI l·ªãch n√†y?";
            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch(`${API_URL}/bookings/${bookingId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await res.json();
                
                if (res.ok) {
                    alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    loadMySchedule(); // T·∫£i l·∫°i b·∫£ng
                } else {
                    alert("‚ùå L·ªói: " + (result.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t"));
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi server!");
                console.error(e);
            }
        }

        function logout() {
            localStorage.removeItem('gym_token');
            localStorage.removeItem('gym_user');
            window.location.href = '../../login.html';
        }

        // Ch·∫°y ngay khi m·ªü trang
        loadMySchedule();
    </script>
</body>
</html>